<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secuenciador Profesional Hash-256</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; }
        .lab-panel { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 4px; }
        /* El Gel ahora tiene un fondo que resalta las bandas */
        .gel-simulation { 
            background: #e2e8f0; 
            border: 2px solid #cbd5e1; 
            position: relative; 
            min-height: 280px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.05);
        }
        /* Bandas más oscuras y nítidas para que SE VEAN */
        .dna-band { 
            background: #0f172a; 
            border-bottom: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.1s ease;
        }
        .dna-band.playing { 
            background: #2563eb; 
            transform: scaleX(1.8); 
            box-shadow: 0 0 12px #3b82f6; 
            z-index: 10;
        }
        .mono { font-family: 'JetBrains Mono', 'Fira Code', monospace; }
        .ui-label { font-size: 0.7rem; font-weight: 800; color: #475569; letter-spacing: 0.1em; }
        #playhead { 
            position: absolute; 
            top: 0; 
            width: 3px; 
            height: 100%; 
            background: #ef4444; 
            display: none; 
            pointer-events: none; 
            z-index: 50; 
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.5);
        }
    </style>
</head>
<body class="p-2 sm:p-6 md:p-10 min-h-screen flex items-center justify-center">

    <div class="w-full max-w-5xl flex flex-col gap-4">
        
        <header class="lab-panel p-5 flex flex-col md:flex-row justify-between items-center gap-4 shadow-md">
            <div class="text-center md:text-left">
                <h1 class="text-xl font-black text-slate-900 tracking-tighter uppercase italic">
                    Secuenciador <span class="text-blue-600">Audio-Hash</span>
                </h1>
                <p class="ui-label uppercase">Análisis Profesional de Datos</p>
            </div>
            <div class="flex flex-wrap justify-center gap-2">
                <button id="btnListen" class="bg-blue-600 text-white text-[10px] font-bold px-4 py-2 hover:bg-blue-700 uppercase rounded">Oír</button>
                <button id="btnDownloadAudio" class="bg-emerald-600 text-white text-[10px] font-bold px-4 py-2 hover:bg-emerald-700 uppercase rounded">Audio</button>
                <button id="btnDownload" class="bg-slate-900 text-white text-[10px] font-bold px-4 py-2 hover:bg-slate-800 uppercase rounded text-xs">PNG</button>
            </div>
        </header>

        <section class="lab-panel p-4 md:p-8 shadow-lg">
            <div class="flex justify-between mb-4">
                <span class="ui-label">Cromatografía de Picos</span>
                <span id="recordStatus" class="text-[10px] text-red-600 font-bold hidden animate-pulse">● GRABANDO...</span>
            </div>
            <canvas id="peakCanvas" class="w-full h-16 md:h-24 mb-6 border-b border-slate-200"></canvas>
            
            <div class="flex justify-between mb-2">
                <span class="ui-label">Secuencia de Electroforesis (BARRAS)</span>
            </div>
            <div id="visualizer" class="gel-simulation w-full flex items-start justify-between px-4 md:px-12 py-6 overflow-hidden rounded">
                <div id="playhead"></div>
                </div>
            <div class="flex justify-between mt-3 px-4 md:px-12">
                <span class="ui-label">INICIO (0x0)</span>
                <span class="ui-label">FIN (0xF)</span>
            </div>
        </section>

        <footer class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="lab-panel p-5 space-y-4">
                <div>
                    <label class="ui-label block mb-2 uppercase">Entrada de Semilla / Texto</label>
                    <input type="text" id="textInput" class="w-full border-2 border-slate-200 p-3 text-sm mono focus:border-blue-500 outline-none rounded" placeholder="Escribe aquí para generar secuencia...">
                </div>
                <div id="drop-zone" class="border-2 border-dashed border-slate-300 p-4 text-center cursor-pointer hover:bg-slate-50 rounded bg-slate-50/50">
                    <input type="file" id="fileInput" class="hidden">
                    <p class="ui-label">Arrastra o Carga un Archivo</p>
                </div>
            </div>

            <div class="lab-panel p-5 bg-slate-900 flex flex-col justify-center">
                <label class="ui-label text-slate-500 mb-2 uppercase">Hash SHA-256 Detectado</label>
                <div id="hashHex" class="mono text-[11px] md:text-[13px] text-blue-400 break-all leading-relaxed bg-black/40 p-3 rounded border border-slate-800 shadow-inner">
                    INICIALIZANDO...
                </div>
            </div>
        </footer>
    </div>

    <canvas id="exportCanvas" style="display:none;"></canvas>

    <script>
        const textInput = document.getElementById('textInput');
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('drop-zone');
        const visualizer = document.getElementById('visualizer');
        const hashHex = document.getElementById('hashHex');
        const peakCanvas = document.getElementById('peakCanvas');
        const playhead = document.getElementById('playhead');
        const recordStatus = document.getElementById('recordStatus');

        let audioCtx, currentHash = "";

        async function getSHA256(data) {
            const buffer = typeof data === 'string' ? new TextEncoder().encode(data) : data;
            const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
            return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function playAndRecord(hash, isExport = false) {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            const dest = audioCtx.createMediaStreamDestination();
            const recorder = isExport ? new MediaRecorder(dest.stream) : null;
            const chunks = [];

            if (isExport) {
                recorder.ondataavailable = e => chunks.push(e.data);
                recorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `HASH_AUDIO.webm`; a.click();
                    recordStatus.classList.add('hidden');
                };
                recorder.start();
                recordStatus.classList.remove('hidden');
            }

            const duration = 0.12;
            const frequencies = [261, 293, 329, 349, 392, 440, 493, 523, 587, 659, 698, 783, 880, 987, 1046, 1174];
            const bands = document.querySelectorAll('.dna-band');
            playhead.style.display = 'block';

            hash.split('').forEach((char, i) => {
                const val = parseInt(char, 16);
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();

                osc.frequency.setValueAtTime(frequencies[val], audioCtx.currentTime + (i * duration));
                gain.gain.setValueAtTime(0.06, audioCtx.currentTime + (i * duration));
                gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + (i * duration) + duration);

                osc.connect(gain);
                gain.connect(audioCtx.destination);
                if (isExport) gain.connect(dest);

                osc.start(audioCtx.currentTime + (i * duration));
                osc.stop(audioCtx.currentTime + (i * duration) + duration);

                setTimeout(() => {
                    playhead.style.left = `${(i * 1.5) + 2}%`;
                    if(bands[i]) bands[i].classList.add('playing');
                    setTimeout(() => { if(bands[i]) bands[i].classList.remove('playing'); }, duration * 1000);
                    if (i === hash.length - 1 && isExport) setTimeout(() => recorder.stop(), 500);
                }, i * duration * 1000);
            });
        }

        async function update(data) {
            currentHash = await getSHA256(data || "INIT_SEED");
            hashHex.innerText = currentHash.toUpperCase();
            
            // Peak Canvas
            const w = peakCanvas.width = peakCanvas.offsetWidth;
            const h = peakCanvas.height = peakCanvas.offsetHeight;
            const pCtx = peakCanvas.getContext('2d');
            pCtx.clearRect(0,0,w,h); 
            pCtx.beginPath(); 
            pCtx.strokeStyle = '#2563eb'; 
            pCtx.lineWidth = 2;
            currentHash.split('').forEach((c,i) => pCtx.lineTo((i/64)*w, h-((parseInt(c,16)+1)/16)*h));
            pCtx.stroke();

            // Gel Visualizer (ESTO GENERA LA SECUENCIA VISIBLE)
            visualizer.innerHTML = '<div id="playhead"></div>';
            currentHash.split('').forEach((c,i) => {
                const val = parseInt(c, 16);
                const bar = document.createElement('div');
                bar.className = 'dna-band absolute';
                // Ancho proporcional para que siempre llenen el contenedor
                bar.style.width = '1.2%';
                bar.style.left = `${(i * 1.5) + 2}%`;
                // Posición vertical basada en el valor hex (0-15)
                bar.style.top = `${(val / 15) * 85}%`;
                // Altura mínima para asegurar visibilidad
                bar.style.height = `${6 + (val % 8)}px`;
                bar.style.opacity = 0.5 + (val / 30);
                visualizer.appendChild(bar);
            });
        }

        // Listeners
        textInput.addEventListener('input', (e) => update(e.target.value));
        dropZone.onclick = () => fileInput.click();
        fileInput.onchange = async (e) => { 
            if(e.target.files[0]) {
                const buf = await e.target.files[0].arrayBuffer();
                update(buf);
            }
        };

        document.getElementById('btnListen').onclick = () => playAndRecord(currentHash, false);
        document.getElementById('btnDownloadAudio').onclick = () => playAndRecord(currentHash, true);
        document.getElementById('btnDownload').onclick = () => {
            const canvas = document.getElementById('exportCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 1200; canvas.height = 800;
            ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.fillStyle = '#0f172a'; ctx.fillRect(0,0,canvas.width,80);
            ctx.fillStyle = '#ffffff'; ctx.font = '24px Arial'; ctx.fillText('REPORTE SECUENCIADOR HASH-256', 40, 50);
            
            currentHash.split('').forEach((c,i) => {
                const val = parseInt(c, 16);
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(50+(i*17), 150+(val/15)*500, 14, 8);
            });
            const a = document.createElement('a'); a.download = 'reporte_genetico.png'; a.href = canvas.toDataURL(); a.click();
        };

        // Iniciar con datos por defecto para que SE VEA AL CARGAR
        window.onload = () => update("SEC-001");
    </script>
</body>
</html>